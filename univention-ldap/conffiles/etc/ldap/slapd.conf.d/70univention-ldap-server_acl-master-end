@!@
ldap_base=baseConfig['ldap/base']
address=baseConfig['interfaces/eth0/address']
if baseConfig['ldap/server/type']=="master":
	usr="write"
else:
	usr="read"

nestedGroups = baseConfig.get('ldap/acl/nestedgroups', 'yes')
if nestedGroups.lower() in ['true', 'yes', 'on', '1']:
	nestedGroups = True
else:
	nestedGroups = False


if baseConfig.has_key('ldap/acl/slavepdc') and baseConfig['ldap/acl/slavepdc'].lower() in ['yes', 'true']:

	print 'access to dn.regex="^cn=([^,]+),cn=([^,]+),cn=temporary,cn=univention,%s" filter="(&(objectClass=lock)(!(objectClass=posixAccount)))"' % ldap_base
	print '   by dn.base="cn=admin,%s" %s' % ( ldap_base, usr )
	if nestedGroups:
		print '   by set="user & [cn=Domain Admins,cn=groups,%s]/uniqueMember*" %s' % ( ldap_base, usr )
	else:
		print '   by group/univentionGroup/uniqueMember="cn=Domain Admins,cn=groups,%s" %s' % ( ldap_base, usr )
	print '   by dn.regex="[^,]+,cn=dc,cn=computers,%s" %s' % ( ldap_base, usr )
	print '   by * read break'
		
	print 'access to dn.regex="^cn=([^,]+),cn=temporary,cn=univention,%s" attrs=children,entry' % ldap_base
	print '   by dn.base="cn=admin,%s" %s' % ( ldap_base, usr )
	if nestedGroups:
		print '   by set="user & [cn=Domain Admins,cn=groups,%s]/uniqueMember*" %s' % ( ldap_base, usr )
	else:
		print '   by group/univentionGroup/uniqueMember="cn=Domain Admins,cn=groups,%s" %s' % ( ldap_base, usr )
	print '   by dn.regex="[^,]+,cn=dc,cn=computers,%s" %s' % ( ldap_base, usr )
	print '   by * read break'

	print 'access to dn.regex="^cn=([^,]+),cn=temporary,cn=univention,%s" attrs=univentionLastUsedValue' % ldap_base
	print '   by dn.base="cn=admin,%s" %s' % ( ldap_base, usr )
	if nestedGroups:
		print '   by set="user & [cn=Domain Admins,cn=groups,%s]/uniqueMember*" %s' % ( ldap_base, usr )
	else:
		print '   by group/univentionGroup/uniqueMember="cn=Domain Admins,cn=groups,%s" %s' % ( ldap_base, usr )
	print '   by dn.regex="[^,]+,cn=dc,cn=computers,%s" %s' % ( ldap_base, usr )
	print '   by * read break'

	print 'access to dn.regex="cn=computers,%s" attrs=children,entry' % ( ldap_base )
	print '   by dn.base="cn=admin,%s" %s' % ( ldap_base, usr )
	if nestedGroups:
		print '   by set="user & [cn=Domain Admins,cn=groups,%s]/uniqueMember*" %s' % ( ldap_base, usr )
	else:
		print '   by group/univentionGroup/uniqueMember="cn=Domain Admins,cn=groups,%s" %s' % ( ldap_base, usr )
	print '   by dn.regex="[^,]+,cn=dc,cn=computers,%s" %s' % ( ldap_base, usr )
	print '   by * read break'

	print 'access to dn.regex=".*,%s" filter="(|(objectClass=univentionWindows)(&(objectClass=univentionGroup)(cn=Windows Hosts)))"' % ( ldap_base )
	print '   by dn.base="cn=admin,%s" %s' % ( ldap_base, usr )
	if nestedGroups:
		print '   by set="user & [cn=Domain Admins,cn=groups,%s]/uniqueMember*" %s' % ( ldap_base, usr )
	else:
		print '   by group/univentionGroup/uniqueMember="cn=Domain Admins,cn=groups,%s" %s' % ( ldap_base, usr )
	print '   by dn.regex="[^,]+,cn=dc,cn=computers,%s" %s' % ( ldap_base, usr )
	print '   by * read break'

	print 'access to dn.regex=".*,%s" filter="(objectClass=sambaDomain)"' % ( ldap_base )
	print '   by dn.base="cn=admin,%s" %s' % ( ldap_base, usr )
	if nestedGroups:
		print '   by set="user & [cn=Domain Admins,cn=groups,%s]/uniqueMember*" %s' % ( ldap_base, usr )
	else:
		print '   by group/univentionGroup/uniqueMember="cn=Domain Admins,cn=groups,%s" %s' % ( ldap_base, usr )
	print '   by dn.regex="[^,]+,cn=dc,cn=computers,%s" %s' % ( ldap_base, usr )
	print '   by * read break'

print 'access to dn.regex="cn=.*,cn=dc,cn=computers,%s" attrs=userPassword,krb5Key,krb5KDCFlags,sambaNTPassword,sambaLMPassword,sambaPwdLastSet,pwhistory,krb5KeyVersionNumber,univentionWindowsReinstall,sambaPwdCanChange,sambaPwdMustChange' % ( ldap_base )
print '   by dn.base="cn=admin,%s" %s' % ( ldap_base, usr )
if nestedGroups:
	print '   by set="user & [cn=Domain Admins,cn=groups,%s]/uniqueMember*" %s' % ( ldap_base, usr )
else:
	print '   by group/univentionGroup/uniqueMember="cn=Domain Admins,cn=groups,%s" %s' % ( ldap_base, usr )
print '   by self %s' % ( usr )
print '   by dn.regex="[^,]+,cn=dc,cn=computers,%s" read' % ( ldap_base )
print '   by * none'

print 'access to dn.regex="cn=.*,cn=memberserver,cn=computers,%s" attrs=userPassword,krb5Key,krb5KDCFlags,sambaNTPassword,sambaLMPassword,sambaPwdLastSet,pwhistory,krb5KeyVersionNumber,univentionWindowsReinstall,sambaPwdCanChange,sambaPwdMustChange' % ( ldap_base )
print '   by dn.base="cn=admin,%s" %s' % ( ldap_base, usr )
if nestedGroups:
	print '   by set="user & [cn=Domain Admins,cn=groups,%s]/uniqueMember*" %s' % ( ldap_base, usr )
else:
	print '   by group/univentionGroup/uniqueMember="cn=Domain Admins,cn=groups,%s" %s' % ( ldap_base, usr )
print '   by dn.regex="[^,]+,cn=dc,cn=computers,%s" %s' % ( ldap_base, usr )
print '   by self %s' % ( usr )
print '   by * none'

print 'access to dn.regex="cn=.*,cn=memberserver,cn=computers,%s" attrs=objectClass,sambaSID,sambaPrimaryGroupSID,displayName,sambaAcctFlags' % ( ldap_base )
print '   by dn.base="cn=admin,%s" %s' % ( ldap_base, usr )
if nestedGroups:
	print '   by set="user & [cn=Domain Admins,cn=groups,%s]/uniqueMember*" %s' % ( ldap_base, usr )
else:
	print '   by group/univentionGroup/uniqueMember="cn=Domain Admins,cn=groups,%s" %s' % ( ldap_base, usr )
print '   by dn.regex="[^,]+,cn=dc,cn=computers,%s" %s' % ( ldap_base, usr )
print '   by * read break'

print 'access to attrs=userPassword,krb5Key,krb5KDCFlags,sambaNTPassword,sambaLMPassword,sambaPwdLastSet,pwhistory,krb5KeyVersionNumber,univentionWindowsReinstall,sambaPwdCanChange,sambaPwdMustChange,sambaPasswordHistory,sambaClearTextPassword,sambaPreviousClearTextPassword'
print '   by dn.base="cn=admin,%s" %s' % ( ldap_base, usr )
if nestedGroups:
	print '   by set="user & [cn=Domain Admins,cn=groups,%s]/uniqueMember*" %s' % ( ldap_base, usr )
else:
	print '   by group/univentionGroup/uniqueMember="cn=Domain Admins,cn=groups,%s" %s' % ( ldap_base, usr )
print '   by dn.regex="[^,]+,cn=dc,cn=computers,%s" %s' % ( ldap_base, usr )
print '   by dn.regex="[^,]+,cn=memberserver,cn=computers,%s" read' % ( ldap_base )
print '   by * none'

print 'access to attrs=shadowMax,krb5PasswordEnd,shadowLastChange'
print '   by dn.base="cn=admin,%s" %s' % ( ldap_base, usr )
if nestedGroups:
	print '   by set="user & [cn=Domain Admins,cn=groups,%s]/uniqueMember*" %s' % ( ldap_base, usr )
else:
	print '   by group/univentionGroup/uniqueMember="cn=Domain Admins,cn=groups,%s" %s' % ( ldap_base, usr )
print '   by dn.regex="[^,]+,cn=dc,cn=computers,%s" %s' % ( ldap_base, usr )
print '   by dn.regex="[^,]+,cn=memberserver,cn=computers,%s" read' % ( ldap_base )
print '   by * read break'

print 'access to dn.base="cn=idmap,cn=univention,%s"' % ( ldap_base )
print '   by dn.base="cn=admin,%s" %s' % ( ldap_base, usr )
if nestedGroups:
	print '   by set="user & [cn=Domain Admins,cn=groups,%s]/uniqueMember*" %s' % ( ldap_base, usr )
else:
	print '   by group/univentionGroup/uniqueMember="cn=Domain Admins,cn=groups,%s" %s' % ( ldap_base, usr )
print '   by dn.regex="[^,]+,cn=dc,cn=computers,%s" %s' % ( ldap_base, usr )
print '   by dn.regex="[^,]+,cn=memberserver,cn=computers,%s" write' % ( ldap_base )
print '   by * none'

print 'access to dn.regex=".*,cn=idmap,cn=univention,%s" filter="(|(&(objectClass=sambaUnixIdPool)(objectClass=organizationalRole)(objectClass=top))(&(objectClass=sambaIdmapEntry)(objectClass=sambaSidEntry)))"' % ( ldap_base )
print '   by dn.base="cn=admin,%s" %s' % ( ldap_base, usr )
if nestedGroups:
	print '   by set="user & [cn=Domain Admins,cn=groups,%s]/uniqueMember*" %s' % ( ldap_base, usr )
else:
	print '   by group/univentionGroup/uniqueMember="cn=Domain Admins,cn=groups,%s" %s' % ( ldap_base, usr )
print '   by dn.regex="[^,]+,cn=dc,cn=computers,%s" %s' % ( ldap_base, usr )
print '   by dn.regex="[^,]+,cn=memberserver,cn=computers,%s" write' % ( ldap_base )
print '   by * none'

print 'access to *'
print '   by dn.base="cn=admin,%s" %s' % ( ldap_base, usr )
if nestedGroups:
	print '   by set="user & [cn=Domain Admins,cn=groups,%s]/uniqueMember*" %s' % ( ldap_base, usr )
else:
	print '   by group/univentionGroup/uniqueMember="cn=Domain Admins,cn=groups,%s" %s' % ( ldap_base, usr )
if baseConfig.is_false('ldap/acl/read/anonymous'):
	print '   by users read'
	ldap_acl_read_anonymous_ips = baseConfig.get('ldap/acl/read/ips')
	if ldap_acl_read_anonymous_ips:
		for ip in ldap_acl_read_anonymous_ips.split(','):
			print '   by peername.ip=%s read' % ip
else:
	print '   by * read'

if configRegistry.get('ldap/replog', '').lower() in ('true', 'yes'):
	print "replogfile /var/lib/univention-ldap/replog/replog"
@!@
