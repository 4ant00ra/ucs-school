@%@BCWARNING=# @%@

access_log /var/log/squid/access.log
pid_filename /var/run/squid/squid.pid

hierarchy_stoplist cgi-bin ?
acl QUERY urlpath_regex cgi-bin \?
no_cache deny QUERY
refresh_pattern ^ftp:		1440	20%	10080
refresh_pattern ^gopher:	1440	0%	1440
refresh_pattern .		0	20%	4320
acl all src 0.0.0.0/0.0.0.0
acl manager proto cache_object
acl localhost src 127.0.0.1/255.255.255.255
@!@
for i in range(0,4):
	if configRegistry['interfaces/eth%s/address' % i]:
		print 'acl localnet%s src %s/%s' % (i, configRegistry['interfaces/eth%s/network' % i], configRegistry['interfaces/eth%s/netmask' % i])
	for j in range(0,4):
		if configRegistry['interfaces/eth%s_%s/address' % (i,j) ]:
			print 'acl localnet%s%s src %s/%s' % (i,j, configRegistry['interfaces/eth%s_%s/network' % (i,j)], configRegistry['interfaces/eth%s_%s/netmask' % (i,j)])
@!@
acl to_localhost dst 127.0.0.0/8
@!@
for i in range(0,4):
	if configRegistry['interfaces/eth%s/address' % i]:
		print 'acl to_localnet%s dst %s/%s' % (i, configRegistry['interfaces/eth%s/network' % i], configRegistry['interfaces/eth%s/netmask' % i])
	for j in range(0,4):
		if configRegistry['interfaces/eth%s_%s/address' % (i,j) ]:
			print 'acl to_localnet%s%s dst %s/%s' % (i,j, configRegistry['interfaces/eth%s_%s/network' % (i,j)], configRegistry['interfaces/eth%s_%s/netmask' % (i,j)])

print ''

if configRegistry['proxy/ldapauth'] == 'yes':
	print 'auth_param basic program /usr/lib/squid/ldap_auth -h '+configRegistry['ldap/server/name']+' -b "'+configRegistry['ldap/base']+'" -s sub -f "(&(objectClass=organizationalPerson)(uid=%s))"'
	print 'auth_param basic children 5'
	print 'auth_param basic realm Univention proxy server'
	print 'auth_param basic credentialsttl 2 hours'
	print 'external_acl_type ldap_group_inetusers ttl=30 %LOGIN /usr/lib/squid/squid_ldap_group -h '+configRegistry['ldap/server/name']+' -b "cn=groups,'+configRegistry['ldap/base']+'" -f"(&(objectClass=univentionGroup)(cn=%g*)(uniqueMember=%u))" -B "'+configRegistry['ldap/base']+'" -F "(uid=%s)"'
	print 'acl inetusers external ldap_group_inetusers www-access'
	print 'http_access allow inetusers'

print ''

if configRegistry['proxy/force'] == 'yes':
	print 'http_port 80 transparent'
else:
	print 'http_port 3128'

print ''

if configRegistry['proxy/ntlmauth'] == 'yes':
	print 'auth_param ntlm program /usr/bin/ntlm_auth --helper-protocol=squid-2.5-ntlmssp'
	print 'auth_param ntlm children 50'

print ''

if configRegistry['proxy/basicauth'] == 'yes':
	print 'auth_param basic program /usr/bin/ntlm_auth --helper-protocol=squid-2.5-basic'
	print 'auth_param basic children 5'
	print 'auth_param basic realm Squid proxy-caching web server'
	print 'auth_param basic credentialsttl 2 hours'
@!@

acl web_ports port 80 443 21
acl purge method PURGE
acl CONNECT method CONNECT

acl AuthorizedUsers proxy_auth REQUIRED
http_access allow AuthorizedUsers

ident_lookup_access allow all

http_access allow manager localhost
http_access deny manager
http_access allow purge localhost
http_access deny purge
#http_access deny !Safe_ports
#http_access deny CONNECT !SSL_ports
http_access deny !web_ports
@!@
if configRegistry['proxy/allow/localnet'] == 'yes':
	print 'http_access allow localhost'
	for i in range(0,4):
		if configRegistry['interfaces/eth%s/address' % i]:
			print 'http_access allow localnet%s' % i
		for j in range(0,4):
			if configRegistry['interfaces/eth%s_%s/address' % (i,j) ]:
				print 'http_access allow localnet%s%s' % (i,j)
@!@

http_access deny all
http_reply_access allow all
icp_access allow all
coredump_dir /var/spool/squid

@!@
if configRegistry['proxy/redirect'] == 'yes':
	print 'redirect_program /usr/bin/squirm'
	print 'redirect_children 10'
elif configRegistry['proxy/redirect'] == 'squidguard':
	print 'redirect_program /usr/bin/squidGuard -c /etc/squid/squidGuard.conf'
elif configRegistry['proxy/redirect'] != 'yes' and configRegistry['proxy/clamav'] == 'yes':
	print 'redirect_program /usr/sbin/squidclamav /etc/squid/squidclamav.conf'
	print 'redirect_children 10'
@!@
forwarded_for off
@!@
if configRegistry['proxy/parent/host']:
	print 'cache_peer '+configRegistry['proxy/parent/host']+' parent '+configRegistry['proxy/parent/port']+' 0 default'
	print 'always_direct allow to_localhost'
	for i in range(0,4):
		if configRegistry['interfaces/eth%s/address' % i]:
			print 'always_direct allow to_localnet%s' % i
		for j in range(0,4):
			if configRegistry['interfaces/eth%s_%s/address' % (i,j) ]:
				print 'always_direct allow to_localnet%s%s' % (i,j)
	print 'never_direct allow all'
@!@
