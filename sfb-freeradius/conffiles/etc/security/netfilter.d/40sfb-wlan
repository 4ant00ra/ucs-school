#! /bin/sh
@%@BCWARNING=# @%@
#
#
# Diese Datei NICHT bearbeiten! 
# Bitte die entsprechenden Univention Config Registry Variablen
# verwenden oder eigene Erweiterungen in die Datei
# /etc/freeradius/firewall.local eintragen!
#

@!@
network = configRegistry.get('interfaces/eth0/network')
network = network[ 0 : network.rfind('.') ]
print 'NETZ="%s"' % network
@!@
GATEWAY="$NETZ.1"
DC="$NETZ.2"

# erste  IP der schulinternen Server
@!@
val = configRegistry.get('freeradius/firewall/server/start', '2')
print 'START_SERVERS="$NETZ.%s"' % val
@!@
# letzte IP der schulinternen Server
@!@
val = configRegistry.get('freeradius/firewall/server/end', '19')
print 'END_SERVERS="$NETZ.%s"' % val
@!@

# erste  IP der Gastnotebooks
@!@
val = configRegistry.get('freeradius/firewall/privateip/start', '240')
print 'START_IP_PRIV="$NETZ.%s"' % val
@!@
# letzte IP der Gastnotebooks
@!@
val = configRegistry.get('freeradius/firewall/privateip/end', '254')
print 'END_IP_PRIV="$NETZ.%s"' % val
@!@

SRC_RANGE="$START_IP_PRIV-$END_IP_PRIV"

### feste Regeln, die den Zugriff aufs Internet erlauben ###

# Zugriff auf Wurmport 135 (egal wohin) sperren
iptables -A FORWARD -m iprange --src-range $SRC_RANGE -p tcp --dport 135 -j DROP

# DHCP erlauben
iptables -A FORWARD -p udp --dport 67 -j ACCEPT

# icmp (ping u.a.) erlauben
iptables -A FORWARD -p icmp -d ! 10.0.0.0/8 -j ACCEPT

# DNS zum DC und Brekom erlauben
iptables -A FORWARD -d     $DC     -p udp --dport 53 -j ACCEPT
@!@
for ip in configRegistry.get('freeradius/firewall/dnsserver', '').split(' '):
	if ip:
		print 'iptables -A FORWARD -d %s -p udp --dport 53 -j ACCEPT' % ip
@!@

# Zugriff auf Router erlauben
iptables -A FORWARD -d    $GATEWAY    -j ACCEPT

# Zugriff auf Radius-Dienste erlauben
iptables -A INPUT -p udp --dport 1812:1813 -j ACCEPT


#####################################################################
# individuelles Regelset:
#####################################################################
#
# Das private Notebook darf auf was noch zugreifen?
#
#####################################################################

# Zugriff auf interne Server erlauben
@!@
val = configRegistry.get('freeradius/firewall/enable/internalserver', 'false')
comment = '# '
if val.lower() in [ '1', 'true', 'yes' ]:
	comment = ''
print '%s%s' % (comment, 'iptables -A FORWARD -m iprange --dst-range $SRC_RANGE -j ACCEPT')
@!@

# Zugriff auf Broadcast erlauben (Netzwerkumgebung Windows)
@!@
val = configRegistry.get('freeradius/firewall/enable/broadcasts', 'false')
comment = '# '
if val.lower() in [ '1', 'true', 'yes' ]:
	comment = ''
print '%s%s' % (comment, 'iptables -A FORWARD -d $NETZ.255 -j ACCEPT')
@!@

# Zugriff auf Radius-Server erlauben:
@!@
val = configRegistry.get('freeradius/firewall/enable/radiusserver', 'false')
comment = '# '
if val.lower() in [ '1', 'true', 'yes' ]:
	comment = ''
print '%s%s' % (comment, 'iptables -A INPUT -j ACCEPT')
@!@

#####################################################################

### feste Regeln, die den Rest verbieten, was bisher nicht explizit erlaubt wurde ###

# Bestehendes nicht unterbinden
iptables -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT

# Zugriff auf Radius-Server verbieten:
iptables -A INPUT -m iprange --src-range $SRC_RANGE -p all -j DROP

# Den Rest verbieten
iptables -A FORWARD -m iprange --src-range $SRC_RANGE -d 10.0.0.0/8 -j DROP


#####################################################################
#
# load custom firewall settings

if [ -r /etc/freeradius/firewall.local ] ; then
	source /etc/freeradius/firewall.local
fi

exit 0
