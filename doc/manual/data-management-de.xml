<chapter id="school:import:general">
  <title>Verwaltung von Schüler-, Lehrer- und Mitarbeiterdaten</title>
  <section id="school:importusers">
	<title>Import von Benutzerkonten für Schüler, Lehrer und Mitarbeiter</title>
	<para>
	  Die Verwaltung der Schüler-, Lehrer und Mitarbeiterdaten und deren Aktualisierung zum
	  Schuljahreswechsel (Versetzungen, Schulabgänge etc.) erfolgt in der Regel durch
	  die Schulverwaltung. Hierbei wird eine große Anzahl an Lösungen zur Datenpflege
	  eingesetzt, die sich von Schulträger zu Schulträger unterscheidet.
	</para>
	<para>
	  Die Benutzerverwaltung von &ucsUAS; ist darauf ausgelegt, dass die
	  primäre Verwaltung der Schuldaten weiterhin durch die Schulverwaltung
	  erfolgt. Diese Daten werden dann in eine Datei im CSV-Format exportiert und
	  in &ucsUAS; importiert. Die einzelnen Felder der CSV-Datei sind durch ein
	  Tabulatorzeichen zu trennen.
	</para>
	<para>
	  Für punktuelle Anpassungen - etwa ein Schulwechsel mitten im Schuljahr -
	  besteht auch die Möglichkeit einzelne Schüler manuell anzulegen. Dies
	  wird im &ucsUAS;-Handbuch für Lehrkräfte beschrieben.
	</para>
	<para>
	  Der Import der Schuldaten ist bei Single- und Multi-Server-Umgebungen identisch.
	</para>
	<para>
	  Der Import von Benutzern erfolgt über das
	  Skript <command>/usr/share/ucs-school-import/scripts/import_user</command>,
	  das auf dem &ucsMaster; als Benutzer <emphasis>root</emphasis> gestartet werden muss.
	  Es erwartet den Namen einer CSV-Datei als ersten Parameter. Das Format
	  der Eingabedatei ist wie folgt aufgebaut:
	</para>
	<table>
	  <title>Aufbau der Datenzeilen für den Benutzer-Import</title>
	  <tgroup cols="4">
		<colspec colnum="1" colname="col1" colwidth="1*"/>
		<colspec colnum="2" colname="col2" colwidth="3*"/>
		<colspec colnum="3" colname="col3" colwidth="2*"/>
		<colspec colnum="4" colname="col4" colwidth="2*"/>
		<thead>
		  <row>
			<entry>Feld</entry>
			<entry>Beschreibung</entry>
			<entry>Mögliche Werte</entry>
			<entry>Beispiel</entry>
		  </row>
		</thead>
		<tbody>
		  <row><entry>Aktion</entry><entry>Art der Benutzermodifikation</entry><entry><emphasis>A</emphasis>=Hinzufügen, <emphasis>M</emphasis>=Modifizieren, <emphasis>D</emphasis>=Löschen</entry><entry>A</entry>
		  </row>
		  <row><entry>Benutzername</entry><entry>Der zum Login verwendete Benutzername</entry><entry>---</entry><entry>m.mustermann</entry></row>
		  <row><entry>Nachname</entry><entry>Der Nachname des Benutzers</entry><entry>---</entry><entry>Mustermann</entry></row>
		  <row><entry>Vorname</entry><entry>Der Vorname des Benutzers</entry><entry>---</entry><entry>Michael</entry></row>
		  <row><entry>OU</entry><entry>Die OU, unter der der Benutzer angelegt werden soll</entry><entry>---</entry><entry>g123m</entry></row>
		  <row><entry>Klasse</entry><entry>Name der Klasse des Benutzers; nur Lehrer können in mehreren Klassen vertreten sein!</entry><entry>---</entry><entry>1A,1B,2A,4C</entry></row>
		  <row><entry>Rechte</entry><entry>derzeit ungenutzt; das Feld sollte leer bleiben, so dass 2 Tabulator-Zeichen aufeinander folgen</entry><entry>---</entry><entry></entry></row>
		  <row><entry>Email-Adresse</entry><entry>Mailadresse des Benutzers</entry><entry>---</entry><entry>m.musterm@beispiel.edu</entry></row>
		  <row><entry>(Lehrer)</entry><entry>Definiert, ob der Benutzer ein Lehrer ist</entry><entry><emphasis>0</emphasis>=Kein Lehrer, <emphasis>1</emphasis>=Lehrer</entry><entry>1</entry></row>
		  <row><entry>(Aktiv)</entry><entry>Definiert, ob das Benutzerkonto beim Anlegen sofort aktiviert wird</entry><entry><emphasis>0</emphasis>=nicht aktivieren, <emphasis>1</emphasis>=aktivieren</entry><entry>1</entry></row>
		  <row><entry>(Mitarbeiter)</entry><entry>Definiert, ob der Benutzer ein Mitarbeiter ist</entry><entry><emphasis>0</emphasis>=Kein Mitarbeiter, <emphasis>1</emphasis>=Mitarbeiter</entry><entry>0</entry></row>
		</tbody>
	  </tgroup>
	</table>
	<para>
	  Ein Beispiel für eine Importdatei:
	</para>
    <programlisting>
A  max        Mustermann  Max    g123m  1A        max@schule.edu   0 1 0
M  m.musterma Mustermann  Moritz g123m  1A,2D,4C  m.m@schule.edu   1 1 0
D  a.musterfr Musterfrau  Anke   g123m  2B        a.mfr@schule.edu 1 1 1
	</programlisting>
	<para>
	  Über das Feld <emphasis>Aktion</emphasis> kann die Art der Benutzermodifikation gesteuert
	  werden. Folgende Aktionen sind definiert:
	</para>
	<informaltable>
	  <tgroup cols="2">
		<colspec colnum="1" colname="col1" colwidth="1*"/>
		<colspec colnum="2" colname="col2" colwidth="1*"/>
		<thead>
		  <row>
			<entry>Aktion</entry>
			<entry>Beschreibung</entry>
		  </row>
		</thead>
		<tbody>
		  <row><entry>A</entry><entry>Hinzufügen</entry></row>
		  <row><entry>M</entry><entry>Modifizieren</entry></row>
		  <row><entry>D</entry><entry>Löschen</entry></row>
		</tbody>
	  </tgroup>
	</informaltable>
	<para>
	  Auch beim Löschen (Aktion <emphasis>D</emphasis>) müssen gültige Werte übergeben werden.
	</para>
	<para>
	  Die Angabe von Klassen bezieht sich bei Schülern in der Regel auf eine
	  einzelne Klasse. Lehrer können dagegen in mehreren Klassen vertreten
	  sein. Diese sollten auch angegeben werden (kommasepariert), damit die
	  Benutzerkonten der Lehrer automatisch in die jeweilige Klassengruppe
	  eingetragen werden und sie somit auch Zugriff auf die jeweilige Dateifreigabe
	  der Klasse erhalten. Bei Mitarbeitern ist das Feld Klasse leer zu lassen.
	</para>
	<para>
	  Die optionalen Felder <emphasis>Lehrer</emphasis> und <emphasis>Mitarbeiter</emphasis> bestimmen die
	  Rolle des Benutzers im System. Werden die Werte nicht angegeben, so
	  wird der Benutzer mit der Rolle Schüler angelegt. Es ist möglich einem
	  Benutzer sowohl die Rollen Lehrer und Mitarbeiter zu geben.
	</para>
	<para>
	  Über das optionale Feld <emphasis>Aktiv</emphasis> wird gesteuert, ob das Benutzerkonto aktiviert
	  werden soll. Ist kein Wert angegeben, wird das Konto automatisch aktiviert.
	</para>
	<para>
	  Die Benutzerkonten werden mit zufälligen,
	  unbekannten Passwörtern initialisiert. Mehrere Personengruppen können die
	  Konten anschließend freischalten:
	</para>
	<itemizedlist>
	  <listitem><simpara>Das Konto eines Schuladministrators kann durch Benutzer der Gruppe <emphasis>Domain Admins</emphasis> in der &ucsUMC; erstellt und modifiziert werden.</simpara></listitem>
	  <listitem><simpara>Die Konten von Mitarbeitern können durch Benutzer der Gruppe <emphasis>Domain Admins</emphasis> in der &ucsUMC; durch die Vergabe eines Passworts freigeschaltet werden.</simpara></listitem>
	  <listitem><simpara>Die Konten von Lehrern können durch den Schuladministrator über das Modul <guimenu>Passwörter (Schüler)</guimenu> durch die Vergabe eines Passworts freigeschaltet werden.</simpara></listitem>
	  <listitem><simpara>Die Konten von Schülern können durch Lehrer über das Modul <guimenu>Passwörter (Lehrer)</guimenu> klassenweise durch die Vergabe eines Passworts freigeschaltet werden.</simpara></listitem>
	</itemizedlist>
	<para>
	  Mit den folgenden &ucsUCR;-Variablen kann für Schüler, Lehrer,
	  Schuladministratoren und Mitarbeiter eine UMC-Richtlinie zugewiesen
	  werden, die festlegt, welche UMC-Module bei einer Anmeldung der
	  entsprechenden Benutzergruppe angezeigt werden. Hierbei muss der LDAP-DN
	  (Distinguished Name) der Richtlinie angegeben werden.
	</para>
	<itemizedlist>
	  <listitem><simpara><envar>ucsschool/ldap/default/policy/umc/pupils</envar> gilt für Anmeldungen von Schülern</simpara></listitem>
	  <listitem><simpara><envar>ucsschool/ldap/default/policy/umc/teachers</envar> gilt für Anmeldungen von Lehrern</simpara></listitem>
	  <listitem><simpara><envar>ucsschool/ldap/default/policy/umc/admins</envar> gilt für Anmeldungen von Schuladministratoren</simpara></listitem>
	  <listitem><simpara><envar>ucsschool/ldap/default/policy/umc/staff</envar> gilt für Anmeldungen von Mitarbeitern</simpara></listitem>
	</itemizedlist>
	<para>
	  Wenn die UCR-Variablen auf den Wert <emphasis>None</emphasis> gesetzt sind, wird für den jeweiligen Benutzertyp keine Richtlinie
	  verknüpft. Es müssen dann eigene Richtlinien an die Container gebunden
	  werden.
	</para>
	<caution>
	  <para>
		Bei der Verwendung von Samba 4 benötigt der S4-Connector einige Zeit, um die Benutzer in die
		Samba 4-Benutzerdatenbank zu synchronisieren. Je nach Menge der Importdaten und der verwendeten
		Hardware kann die Synchronisation einige Stunden benötigen. Währenddessen kann es zu Verzögerungen
		in der Synchronisation von nicht-import-abhängigen Änderungen im LDAP oder Active Directory kommen
		(z.B. interaktive Änderung von Benutzerpasswörtern).
	  </para>
	</caution>

	<section id="school:importusers:windowsattributes">
	  <title>Windows-spezifische Benutzereinstellungen</title>
	  <para>
		Neben den in <xref linkend="school:importusers"/> genannten Attributen für Benutzer werden
		beim Anlegen eines Benutzers auch automatisch einige Windows-spezifische Einstellungen vorgenommen:
		<itemizedlist>
		  <listitem>
			<simpara> 
			  Für die Verwendung von Samba ist es notwendig, dass für jeden Benutzer ein Pfad für
			  das Windows-Benutzerprofil vorgegeben wird. In der Standardeinstellung von &ucsUAS; wird der
			  jeweilige Logonserver als Ablageort für das Benutzerprofil definiert
			  (<emphasis>\\%LOGONSERVER%\%USERNAME%\windows-profiles\default</emphasis>).  Falls die
			  Benutzerprofile abweichend auf einem anderen Dateiserver gespeichert werden sollen, kann in der
			  &ucsUMC; am Rechnerobjekt des gewünschten Dateiservers der Dienst <emphasis>Windows Profile
			  Server</emphasis> gesetzt werden. 
			  <note>
				<para>
				  Für den reibungslosen Betrieb darf der Dienst nur an einem Dateiserver pro OU
				  gesetzt werden. Weiterhin ist der Dienst <emphasis>Windows Profile Server</emphasis> veraltet und wird in
				  einer zukünftigen &ucsUAS;-Version entfernt bzw. durch einen äquivalenten Mechanismus ersetzt.
				</para>
			  </note>
			</simpara>
		  </listitem>
		  <listitem>
			<simpara>
			  Darüber hinaus wird auch automatisch der Pfad zum Heimatverzeichnis des Benutzers
			  gesetzt. In einer Single-Server-Umgebung wird automatisch der Domaincontroller Master als
			  Dateiserver eingetragen. In Multi-Server-Umgebungen ist der für die OU zuständige Dateiserver am
			  OU-Objekt hinterlegt. Um diesen zu ändern, muss in der &ucsUMC; das OU-Objekt geöffnet werden und
			  auf dem Reiter <emphasis>UCS@school</emphasis> im Auswahlfeld <emphasis>Server für
			  Windows-Heimatverzeichnisse</emphasis> ein geeigneter Dateiserver ausgewählt werden. Der dort
			  definierte Dateiserver wird beim Anlegen eines Benutzers ausgelesen und der Pfad am Benutzerobjekt
			  entsprechend gesetzt (Beispiel: <emphasis>\\server3.example.com\benutzer123</emphasis>).
			</simpara>
		  </listitem>
		</itemizedlist>
		<note>
		  <para>
			Die Windows-spezifischen Einstellungen werden nur beim Anlegen eines Benutzers
			gesetzt. Ein nachträgliches Modifizieren des Benutzers über die Importskripte hat keinen Einfluss
			auf diese Einstellungen.
		  </para>
		</note>
	  </para>
	</section>
	
	<section id="school:importusers:staff">
	  <title>Manuelles Anlegen von Benutzerkonten für Mitarbeiter</title>
	  <para>
		Benutzerkonten für Mitarbeiter können auch über das UMC-Modul <guimenu>Benutzer</guimenu>
		auf dem &ucsMaster; angelegt werden.
	  </para>
	  <para>
		Die Mitarbeiterkonten müssen unterhalb der OU der Schule im
		Container <emphasis>cn=mitarbeiter,cn=users</emphasis> erstellt werden. Die Auswahl
		findet mit der Option <guimenu>Container</guimenu> beim Anlegen eines
		Benutzers statt. Bei einer OU <emphasis>gym17</emphasis> muss
		beispielsweise der Container <emphasis>gym17/users/mitarbeiter</emphasis> ausgewählt werden.
	  </para>
	  <para>
		Der Benutzer muss außerdem im Reiter <guimenu>Gruppen</guimenu> in die Gruppe
		<emphasis>mitarbeiter-OU</emphasis>, also z.B. <emphasis>mitarbeiter-gym17</emphasis>, aufgenommen
		werden.
	  </para>
	</section>
	<section id="school:importusers:schooladmins">
	  <title>Anlegen von Benutzerkonten für Schuladministratoren</title>
	  <para>
		Benutzerkonten von Lehrern können durch eine zusätzliche Gruppenmitgliedschaft zu
		Schuladministratoren umgewandelt werden. Sie unterliegen dann jedoch der Einschränkung, dass die
		Benutzerkonten der Lehrer-Schuladministratoren nur auf den edukativen Schulserver und nicht auf den
		Schulserver des Verwaltungsnetzes repliziert werden.
	  </para>
	  <para>
		Die zusätzliche Gruppenmitgliedschaft muss manuell über das UMC-Modul
		<guimenu>Benutzer</guimenu> auf dem &ucsMaster; hinzugefügt werden. Auf dem Reiter
		<guimenu>Gruppen</guimenu> muss das Benutzerkonto in die Gruppe <emphasis>admins-OU</emphasis> (bei
		der OU <emphasis>gym17</emphasis> ist dies die Gruppe <emphasis>admins-gym17</emphasis>) aufgenommen
		werden.
	  </para>
	  <para>
		Soll das Benutzerkonten des Schuladministrators auch auf den Systemen des Verwaltungsnetzes
		verfügbar sein, so reicht es nicht aus, die Gruppenmitgliedschaft zu ändern. Es muss manuell
		ein neues Benutzerkonto über das UMC-Modul <guimenu>Benutzer</guimenu> auf dem &ucsMaster;
		angelegt werden.
	  </para>
	  <para>
		Die Benutzerkonten der Schuladministratoren müssen unterhalb der OU der Schule im Container
		<emphasis>cn=admins,cn=users</emphasis> angelegt werden. Die Auswahl findet mit der Option
		<guimenu>Container</guimenu> beim Anlegen eines Benutzers statt. Bei einer OU
		<emphasis>gym17</emphasis> muss beispielsweise der Container <emphasis>gym17/users/admins</emphasis>
		ausgewählt werden.
	  </para>
	  <para>
		Der Benutzer muss außerdem im Reiter <guimenu>Gruppen</guimenu> in die Gruppe
		<emphasis>admins-OU</emphasis>, also z.B. <emphasis>admins-gym17</emphasis> aufgenommen werden.
	  </para>
	  <para>
		Sollte der Schuladministrator auch als Lehrer tätig sein, muss zusätzlich die Gruppe
		<emphasis>lehrer-OU</emphasis>, also z.B. <emphasis>lehrer-gym17</emphasis>, hinzugefügt werden.
	  </para>
	  <para>
		Abschließend müssen die Angaben für Profilpfad und Heimatverzeichnispfad am Benutzerobjekt
		gesetzt werden, um das gleiche Verhalten wie bei Schüler- und Lehrerkonten zu erhalten (siehe dazu
		auch <xref linkend="school:importusers:windowsattributes"/>).
	  </para>
	</section>
  </section>

  <section>
	<title>Skriptgesteuerter Import von Klassen</title>
	<para>
	  Klassen werden in der Regel durch die entsprechenden UMC-Module verwaltet 
	  (siehe &ucsUAS;-Lehrerhandbuch <biblioref linkend="ucs-school-teacher"/>). Es besteht
	  jedoch auch die Möglichkeit, Klassen skriptbasiert zu importieren.
	</para>
	<para>
	  Es ist zu beachten, dass die Klassennamen domänenweit eindeutig sein müssen. Das heißt eine
	  Klasse <emphasis>1A</emphasis> kann nicht in mehreren OUs verwendet werden. Daher sollte jedem
	  Klassennamen die OU vorangestellt werden. Bei der Erstellung von Klassen über das UMC-Modul
	  <emphasis>Klasse hinzufügen</emphasis> geschieht dies automatisch. Sprechende Namen, wie zum
	  Beispiel <emphasis>Igel</emphasis> oder <emphasis>BiologieAG</emphasis>, sind für Klassennamen
	  ebenso möglich wie Buchstaben-Ziffern-Kombinationen (<emphasis>10R</emphasis>). Beispiele für die
	  Schule gym123:
	</para>
	<programlisting>gym123-1A
gym123-1B
gym123-2A
gym123-Igel</programlisting>
	<para>
	  Das Dateiformat für die Gruppen-Importdatei ist wie folgt aufgebaut:
	</para>
	<table>
	  <title>Aufbau der Datenzeilen für den Gruppen-Import</title>
	  <tgroup cols="4">
		<colspec colnum="1" colname="col1" colwidth="1*"/>
		<colspec colnum="2" colname="col2" colwidth="3*"/>
		<colspec colnum="3" colname="col3" colwidth="1*"/>
		<colspec colnum="4" colname="col4" colwidth="1*"/>
		<thead>
		  <row>
			<entry>Feld</entry>
			<entry>Beschreibung</entry>
			<entry>Mögliche Werte</entry>
			<entry>Beispiel</entry>
		  </row>
		</thead>
		<tbody>
		  <row>
			<entry>Aktion</entry>
			<entry>Art der Gruppenmodifikation</entry>
			<entry><emphasis>A</emphasis>=Hinzufügen, <emphasis>M</emphasis>=Modifizieren, <emphasis>D</emphasis>=Löschen</entry>
			<entry>A</entry>
		  </row>
		  <row>
			<entry>OU</entry>
			<entry>OU, in der die Gruppe modifiziert werden soll</entry>
			<entry>---</entry>
			<entry>g123m</entry>
		  </row>
		  <row>
			<entry>Gruppenname</entry>
			<entry>Der Name der Gruppe</entry>
			<entry>---</entry>
			<entry>g123m-1A</entry>
		  </row>
		  <row>
			<entry>(Beschreibung)</entry>
			<entry>Optionale Beschreibung der Gruppe</entry>
			<entry>---</entry>
			<entry>Klasse 1A</entry>
		  </row>
		</tbody>
	  </tgroup>
	</table>
	<para>
	  Ein Beispiel für eine Importdatei:
	</para>
	<programlisting>
A	  g123m		g123m-1A		 Klaaassen 1A
A	  g123m		g123m-LK-Inf	 Leistungskurs Informatik
M	  g123m		g123m-1A		 Klasse 1A
D	  g123m		g123m-LK-Inf	 Leistungskurs Informatik
D	  g123m		g123m-R12		 Klasse R12
	</programlisting>
  </section>

  <section>
	<title>Vorgehen zum Schuljahreswechsel</title>
	<para>
	  Zum Schuljahreswechsel stehen zahlreiche Änderungen in den
	  Benutzerdaten an: Schüler werden in eine höhere Klasse versetzt, der
	  Abschlussjahrgang verlässt die Schule und ein neuer Jahrgang wird
	  eingeschult.
	</para>
	<para>
	  Ein Schuljahreswechsel erfolgt in vier Schritten:
	</para>
	<orderedlist>
	  <listitem>
		<simpara>Eine Liste aller Schulabgänger wird aus der
		Schulverwaltungssoftware exportiert und die Konten werden über das Import-Skript
		entfernt (Aktion D, siehe <xref linkend="school:importusers"/>).
		Die Klassen der Schulabgänger müssen ebenfalls über das
		Import-Skript für Gruppen entfernt werden.
		</simpara>
	  </listitem>
	  <listitem>
		<para>Die bestehenden Klassen sollten umbenannt werden. Dies stellt
		sicher, dass Dateien, die auf einer Klassenfreigabe gespeichert werden
		und somit einer Klasse zugeordnet sind, nach dem Schuljahreswechsel
		weiterhin der Klasse unter dem neuen Klassennamen zugeordnet sind.
		</para>
		<para>
		  Die ältesten Klassen (die der Abgänger zum Schulende) müssen zuvor
		  gelöscht werden. Die Umbenennung erfolgt über das
		  Skript <command>/usr/share/ucs-school-import/scripts/rename_class</command>,
		  das auf dem &ucsMaster; als Benutzer <emphasis>root</emphasis> aufgerufen werden
		  muss. Es erwartet den Namen einer tab-separierten CSV-Datei als ersten
		  Parameter. Die CSV-Datei enthält dabei pro Zeile zuerst den alten und dann den
		  neuen Klassennamen, z.B.
		</para>
		<programlisting>gymmitte-6B		gymmitte-7B
gymmitte-5B		gymmitte-6B</programlisting>
		<para>
		  Die Reihenfolge der Unbenennung ist wichtig, da die Umbenennung
		  sequentiell erfolgt und der Zielname nicht existieren darf.
		</para>
		<note>
		  <para>
			Beim Umbenennen der Klassen-Freigaben werden auch deren Werte für
			<guimenu>Samba-Name</guimenu> sowie die <guimenu>erzwungene Gruppe</guimenu> automatisch angepasst,
			sofern diese noch die Standardwerte des UCS@school-Importskriptes aufweisen. Bei manuellen
			Änderungen müssen diese Werte nach dem Umbenennen der Klasse nachträglich manuell angepasst werden.
		  </para>
		</note>
	  </listitem>
	  <listitem>
		<simpara>Eine aktuelle Liste aller verbleibenden Schülerdaten wird über das
		Import-Skript neu eingelesen (Aktion M, siehe <xref linkend="school:importusers"/>).
		</simpara>
	  </listitem>
	  <listitem>
		<simpara>Eine Liste aller Neuzugänge wird aus der
		Schulverwaltungssoftware exportiert und über das Import-Skript
		importiert (Aktion A, siehe <xref linkend="school:importusers"/>).
		</simpara>
	  </listitem>
	</orderedlist>
  </section>
</chapter>
