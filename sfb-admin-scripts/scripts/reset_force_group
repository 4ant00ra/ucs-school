#!/bin/bash

eval `univention-config-registry shell`

get_shares(){
	ou=$1
	gidNumber=`ldapsearch -x -b cn="Domain Users $ou,cn=groups,ou=$ou,$ldap_base" gidNumber |grep ^gidNumber| sed -e 's|gidNumber: ||'`
	ldapsearch -x -b cn=klassen,cn=shares,ou=$ou,$ldap_base '(&(!(univentionShareSambaForceGroup=+*))(objectclass=univentionShareSamba))' cn | grep "^dn: cn" | sed -e 's|dn: ||'
}

set_group(){
	dn="$1"
	group=`echo $dn | sed -e 's|cn=||'|sed -e 's|,cn=.*||'`
	univention-directory-manager shares/share modify --dn "$dn" --set sambaForceGroup="+$group"
}


ous=`ldapsearch -x ou=* ou -LLL | grep ^ou | sed -e 's|ou: ||'`

for ou in $ous;
  do
  echo "set groups for ou $ou"
  get_shares $ou | while read dn; do set_group "$dn"; done
done