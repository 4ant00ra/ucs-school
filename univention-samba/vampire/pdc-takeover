#!/bin/bash
#
# Univention Samba
#  Imports Accounts and Groups from a Windows NT-PDC
#
# Copyright (C) 2004, 2005, 2006 Univention GmbH
#
# http://www.univention.de/
#
# All rights reserved.
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License version 2 as
# published by the Free Software Foundation.
#
# Binary versions of this file provided by Univention to you as
# well as other copyrighted, protected or trademarked materials like
# Logos, graphics, fonts, specific documentations and configurations,
# cryptographic keys etc. are subject to a license agreement between
# you and Univention.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA

LOGFILE=/var/log/univention/pdc-takeover.log

eval `univention-baseconfig shell`

display_help() {
	cat <<-EOL
	Syntax:
	  univention-pdc-takeover [-h | --version | <domainname> <NT4PDCname> <adminlogin> <password>]

	Options:
	  -h | --help | -?:
	    print this usage message and exit program

	  --version
	    print version information and exit program

	Description:
        univention-pdc-takeover imports Accounts and Groups from a Windows-NT PDC
        Enhanced Information ist appended to /var/log/univention/pdc-takeover.log

        Called without arguments you will be asked.

	Known-Bugs:
	  -None-

	EOL
	exit 0
}

display_header() {
	echo ""
	echo "univention-pdc-takeover: Import Accounts and Groups from Windows NT"
	echo "copyright (c) 2001-@%@copyright_lastyear@%@ Univention GmbH, Germany"
	echo ""
}

display_version() {
	echo "univention-pdc-takeover @%@package_version@%@"
	exit 0
}

error() {
	echo ""
	echo ""
    echo "ERROR during takeover:" | tee -a $LOGFILE
	echo "  $1" | tee -a $LOGFILE
	echo ""
    exit 1
}

info() {
	echo $2 "  $1"
	echo "$1" >> $LOGFILE
}

display_header

if [ "$#" -gt "0" ]; then
	case $1 in
		--version)
			display_version
			;;
		*)
			if  [ "$#" -ne "4" ]
				then
				display_help
			else
				DOMAINNAME="$1"
				PDCNAME="$2"
				ADMINISTRATOR="$3"
				PASSWORD="$4"
			fi
			;;
	esac
fi

if  [ "$#" -ne "4" ]
	then
	read -p " Domainname:            " DOMAINNAME
	read -p " PDC Hostname:          " PDCNAME
	read -p " Administrator Account: " ADMINISTRATOR
	read -s -p " Password:              " PASSWORD
fi

echo ""
echo "User-, group- and computeraccounts which are in the local LDAP - with"
echo "the same name but a different RID - will not be actualized by default."
echo "They will only become an update of the changed SID-Part. You can select"
echo "to remove the samba-account-parts for users, groups and computers, but "
echo "if existing accounts are not part of your domain they will not be able"
echo "to log into samba/windows."
echo ""
read -p " Remove Samba-Attributes from users (y/N)   " SMBREM_USER
SMBREM_USER=`echo $SMBREM_USER | cut -c 1 | sed -e 's/Y/y/'`
if [ "$SMBREM_USER" = "y" ]
	then
	info "Samba-Attributes for users will be removed"
else
	info "Samba-Attributes for users will not be removed"
	SMBREM_USER='n'
fi

read -p " Remove Samba-Attributes from groups (y/N)   " SMBREM_GROUP
SMBREM_GROUP=`echo $SMBREM_GROUP | cut -c 1 | sed -e 's/Y/y/'`
if [ "$SMBREM_GROUP" = "y" ]
	then
	info "Samba-Attributes for groups will be removed"
else
	info "Samba-Attributes for groups will not be removed"
	SMBREM_GROUP='n'
fi

read -p " Remove Samba-Attributes from computers (y/N)  " SMBREM_COMPUTER
SMBREM_COMPUTER=`echo $SMBREM_COMPUTER | cut -c 1 | sed -e 's/Y/y/'`
if [  "$SMBREM_COMPUTER" = "y" ]
	then
	info "Samba-Attributes for computers will be removed"
else
	info "Samba-Attributes for computers will not be removed"
	SMBREM_COMPUTER='n'
fi

info ""
info "----------------------------------------------------------------------"
d=`date`
info "$d: Start Domain-takeover"
info "----------------------------------------------------------------------"
info ""

if [ $SMBREM_USER = "y" ]
	then
	info "remove sambaSamAccount from users..." -n
	/usr/share/univention-samba/remove-samba-account '(&(objectClass=posixAccount)(objectClass=shadowAccount)(objectClass=person)(objectClass=organizationalPerson)(objectClass=inetOrgPerson)(objectClass=SambaSamAccount))' || error "failed to modify existing users"
	info "done"
fi

if [ $SMBREM_GROUP = "y" ]
	then
	info "remove sambaSamAccount from groups..." -n
	/usr/share/univention-samba/remove-samba-account '(&(objectClass=univentionGroup)(objectClass=SambaGroupMapping))'  || error "failed to modify existing groups"
	info "done"
fi

if [ $SMBREM_COMPUTER = "y" ]
	then
	info "remove sambaSamAccount from computers..." -n
	/usr/share/univention-samba/remove-samba-account '(&(objectClass=posixAccount)(objectClass=univentionWindows)(objectClass=SambaSamAccount)(!(sambaAcctFlags=[I          ])))'  || error "failed to modify existing computers"
	info "done"
fi


info "stopping Samba PDC... " -n
/etc/init.d/samba stop >> $LOGFILE 2>&1 || error "failed to stop samba (init-script failed)"
info "OK."

info "deleting local cache... " -n
rm -f /var/run/samba/gencache.tdb >> $LOGFILE 2>&1  || error "failed to delete cache (/var/run/samba/gencache.tdb)"
info "OK."

info "looking up previous Windows PDC for \"$DOMAINNAME\"... " -n
net lookup dc $DOMAINNAME  >> $LOGFILE 2>&1 || error "failed to lookup Windows PDC, check if Domain is reachable"
info "OK."

info "preparing local configuration... " -n
univention-baseconfig set windows/domain=$DOMAINNAME  >> $LOGFILE 2>&1 || error "failed to write local configuration"
info "OK."

if [ -x "/etc/init.d/nscd" ]; then
	info "restart nscd... " -n
	if /etc/init.d/nscd restart >> $LOGFILE 2>&1
		then
		info "OK."
	else
		info "failed to restart nscd, ignored"
	fi
fi

info "importing configuration of previous Windows PDC: "
/usr/share/univention-samba/import_pdc $DOMAINNAME $PDCNAME $ADMINISTRATOR $PASSWORD $LOGFILE
case $? in
	0)
		info "import OK."
		;;
	1)
		error "failed to takeover, couldn't contact PDC to get new SID. Verify that username and pasword are correct."
		;;
	2)
		error "failed to takeover, couldn't get actual SID from local LDAP. Verify that slapd is running."
		;;
	3)
		error "failed to takeover, couldn't set the new SID in local LDAP."
		;;
	4)
		error "failed to takeover, couldn't join into the windows-domain, check if servername, username and password is correct."
		;;
	5)
		error "failed to takeover, import of account failed, check logfile."
		;;
	6)
		error "takeover stopped, couldn't generate kerberos keys, check logfile."
		;;
	7)
		error "takeover stopped, couldn't fix local SID in LDAP, check logfile."
		;;
	8)
		error "takeover stopped, couldn't copy contens of netlogon share, check logfile."
		;;
esac

info "----------------------------------------------------------------------"
info "Takeover finished. Shut down previous Windows PDC and press Enter to continue"
info "----------------------------------------------------------------------"
read
info "----------------------------------------------------------------------"
info "Do you want to start Samba PDC now? [Y/n]"
info "----------------------------------------------------------------------"
while [ -z "$answer" ]
do
	read -s answer
	if [ -z $answer ]
	then
		answer="Y"
	fi
	case "$answer" in
	Y | y) 	info "starting Samba PDC... " -n
		/etc/init.d/samba start  >> $LOGFILE 2>&1 || error "failed to start samba after import"
		info "OK."
		info ""
		info "Domain takeover was successful."
		break
		;;
	N | n) 	info "Don\`t start Samba PDC !" -n
		info "You can start Samba PDC manually using \"/etc/init.d/samba start\""
		break
		;;
	*) 	info "Not a valid answer"
		answer=""
		;;
	esac
done
info "----------------------------------------------------------------------"
