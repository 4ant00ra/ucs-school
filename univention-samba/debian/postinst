#! /bin/sh
#
# Univention Samba
#  postinst script for the debian package
#
# Copyright (C) 2001-2009 Univention GmbH
#
# http://www.univention.de/
#
# All rights reserved.
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License version 3 as
# published by the Free Software Foundation.
#
# Binary versions of this file provided by Univention to you as
# well as other copyrighted, protected or trademarked materials like
# Logos, graphics, fonts, specific documentations and configurations,
# cryptographic keys etc. are subject to a license agreement between
# you and Univention.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA

createLogfile () {
	if [ ! -e $1 ] ; then
		touch $1
		chown $2 $1
		chmod $3 $1
	fi
}

eval `univention-config-registry shell`

createLogfile /var/log/univention/samba-sync.log "root:adm" 640
createLogfile /var/log/univention/pdc-takeover.log "root:adm" 640

if [ -z "$2" ]
	then
	mkdir -p /home/groups

	mkdir -p /var/lib/samba/netlogon/scripts
	if [ ! -e /var/lib/samba/netlogon/scripts/startup.cmd ]; then
		cp /usr/share/doc/univention-samba/startup.cmd /var/lib/samba/netlogon/scripts/startup.cmd;
	fi;

	mkdir -p /etc/univention/skel/windows-profiles
	mkdir -p /etc/univention/skel/windows-profiles/{Win95,WinNT,Win2k,WinXP,Win2K3,Vista,Vista.V2}
fi

# create the profile directories during the UCS 2.0 upgrade
if [ "$1" = configure -a -n "$2" ] && dpkg --compare-versions "$2" lt 1.0.8-1; then
	mkdir -p /etc/univention/skel/windows-profiles
	mkdir -p /etc/univention/skel/windows-profiles/{Win95,WinNT,Win2k,WinXP,Win2K3,Vista,Vista.V2}
fi


univention-config-registry set samba/share/home?yes
univention-config-registry set samba/share/groups?no
univention-config-registry set samba/adminusers?administrator

if [ "$server_role" != "memberserver" ]
then
	if [ -n "$samba_netbios_name" ]
	then
		tmphostname=$samba_netbios_name
	elif [ -n "$samba_ha_master" ]
	then
		tmphostname="$samba_ha_master"
	else
		tmphostname="$hostname"
	fi
	univention-config-registry set samba/profileserver?$tmphostname
	univention-config-registry set samba/profilepath?'%U\windows-profiles\%a'
	univention-config-registry set samba/homedirserver?$tmphostname
	univention-config-registry set samba/homedirpath?%U
	univention-config-registry set samba/homedirletter?I
fi
#DEBHELPER#

if [ "$1" = configure -a -n "$2" ] && dpkg --compare-versions "$2" lt 0.37; then
	echo converting old policy descriptions
	if [ -f /var/lib/samba/account_policy.tdb -a \( "`which tdbexport`" != "" -a "`which tdbimport`" != "" \) ]; then
		export outfile=`mktemp`
		tdbexport /var/lib/samba/account_policy.tdb | \
		  sed "s/\ (seconds\ since\ 1970)//" > $outfile
		tdbimport -o /var/lib/samba/account_policy.tdb < $outfile
		rm $outfile
	fi
fi


if [ -z "$windows_domain" ]; then
	domain=`echo $domainname | cut -d"." -f 1 | tr "[:lower:]" "[:upper:]"`
	univention-config-registry set windows/domain=$domain
fi

univention-config-registry set samba/debug/level?0
univention-config-registry set samba/os/level?65

/usr/lib/univention-install/26univention-samba.inst || true
if [ "$1" = configure -a -n "$2" ] && dpkg --compare-versions "$2" lt 0.17; then
	if [ "$server_role" = "memberserver" ]; then
		univention-config-registry set samba/user="$ldap_hostdn"
		sleep 2
		smbpasswd -w `cat /etc/machine.secret`
	fi
fi
univention-config-registry set samba/script/adduser?true \
				samba/script/deleteuser?true \
				samba/script/addgroup?true \
				samba/script/deletegroup?true \
				samba/script/addusertogroup?true \
				samba/script/deleteuserfromgroup?true \
				samba/script/addmachine?true \
				samba/script/setprimarygroup?true \
				samba/script/postusermodify?false \
				samba/winbind/nested/groups?no \
				samba/winbind/trusted/domains/only?yes \
				samba/encrypt_passwords?yes \
				samba/use_spnego?yes \
				samba/client_use_spnego?yes \
				samba/oplocks?yes \
				samba/kernel_oplocks?yes \
				samba/large_readwrite?yes \
				samba/deadtime?15 \
				samba/read_raw?yes \
				samba/write_raw?yes \
				samba/max_xmit?65535 \
				samba/getwd_cache?yes \
				samba/store_dos_attributes?yes \
				samba/preserve_case?yes \
				samba/short_preserve_case?yes \
				samba/time_server?yes \
				samba/guest_account?nobody \
				samba/map_to_guest?"Bad User" \
				samba/invalid_users?"daemon bin sys sync games man lp mail news uucp proxy majordom postgres www-data backup msql operator list irc gnats alias qmaild qmails qmailr qmailq qmaill qmailp telnetd identd ftp rwhod gdm fetchmail faxmaster" \
				samba/netlogon/sync?sync \
				samba/domain/logons?auto

if [ "$1" = "configure" -a -n "$2" ];
	then
	/etc/init.d/samba crestart
fi

if [ "$1" = configure -a -z "$2" ]; then
	# only set this for new installations
	univention-config-registry set samba/autostart="no"
	if [ "$server_role" = "domaincontroller_master" ]; then
		univention-config-registry set windows/wins-support=yes
	else
		univention-config-registry set windows/wins-support?no
		univention-config-registry set windows/wins-server?$ldap_master
	fi
fi

if [ "$1" = configure -a -n "$2" ] && dpkg --compare-versions "$2" lt 0.4; then

	/etc/init.d/univention-directory-listener restart
	univention-directory-listener-ctrl resync samba-shares
fi


if [ "$1" = "configure" ]; then
	if test -f /etc/init.d/univention-directory-listener
		then
		/etc/init.d/univention-directory-listener crestart
	fi
fi

exit 0
