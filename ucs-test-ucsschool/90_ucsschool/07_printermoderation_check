#!/usr/share/ucs-test/runner python
## desc: ucs-school-printermoderator-module-check
## roles: [domaincontroller_master, domaincontroller_backup, domaincontroller_slave, memberserver]
## tags: [apptest]
## exposure: careful
## packages:  [ucs-school-umc-printermoderation]

from mimetypes import MimeTypes
from univention.lib.umc_connection import UMCConnection
from univention.management.console.modules import printermoderation
import subprocess
import sys
import tempfile
import time
import univention.testing.strings as uts
import univention.testing.ucr as ucr_test
import univention.testing.ucsschool as utu
import univention.testing.utils as utils


# Order print job for postscript test page
def orderPrint(printer, username, file):
	cmd = ['lpr', '-P', printer, '-U', username, file]
	retval = subprocess.call(cmd)
	if retval:
		utils.fail('Orderprint failure:', retval)

# add / del / modify Printer
def doPrinter(operation, printer_name, schoolName, spool_host):
	uri = '%s://%s' % ('lpd', '10.200.20.20')
	print_server = '%s.%s.%s' % (spool_host, 'univention', 'local')
	f = tempfile.NamedTemporaryFile(suffix='.csv')
	line = '%s\t%s\t%s\t%s\t%s\n' % (operation, schoolName, print_server,
			printer_name, uri)
	f.write(line)
	f.flush()
	cmd = ['/usr/share/ucs-school-import/scripts/import_printer', f.name]
	retval = subprocess.call(cmd)
	f.close()
	if retval:
		utils.fail('Unexpected error while acting on Printer', retval)

# check the existance of the created printer
def printerExist(connection, printerName, schoolName, basedn):
	return connection.request('printermoderation/printers')

# get the current printed jobs
def queryPrintJobs(connection, printerName, cName, schoolName, pattern, basedn):
	if cName != 'None':
		cdn = 'cn=%s,cn=klassen,cn=schueler,cn=groups,ou=%s,%s' % (cName, schoolName, basedn)
	else:
		cdn = cName
	param = {
			'school': schoolName,
			'class': cdn,
			'pattern': pattern
			}
	return connection.request('printermoderation/query', param)

# delete a specific printjob
def delPrintJob(connection, userName, printJob):
	param = {
			'username': userName,
			'printjob': printJob
			}
	return connection.request('printermoderation/delete', param)

# Check the file type of the printed pdf
# there is another lib: python-magic but it is not installed by default
def checkPrintJobs(printJobs):
	mime = MimeTypes()
	for job in printJobs:
		mime_type, _ = mime.guess_type(job)
		if not '/pdf' in mime_type:
			utils.fail('Unexpected file type')

# download print jobs
def downloadPrintJobs(connection, userName, printJob):
	param = {
			'username': userName,
			'printjob': printJob
			}
	try:
		requestResult = connection.request('printermoderation/download', param)
	except Exception as e:
		ex_en = 'No JSON object could be decoded'
		if not ex_en in e:
			utils.fail('Enexpected exception:', e)

# get print jobs for a specific user
def getPrintJobs(alljobs, userName):
	return ([x['id'] for x in alljobs if x['username']==userName])

# Accept printjobs and send them to the hard printer
def acceptprint(connection, userName, printJob, printerName):
	param = {
			'username': userName,
			'printjob': printJob,
			'printer': printerName
			}
	requestResult = connection.request('printermoderation/printit', param)
	print 'request/printermoderation/printit = ', requestResult


def main():
	with utu.UCSTestSchool()  as schoolenv:
		default_printer = 'PDFDrucker'
		newPrinterName = uts.random_string()
		test_file = 'testpage.ps'
		ucr = ucr_test.UCSTestConfigRegistry()
		ucr.load()
		host = ucr.get('hostname')
		basedn = ucr.get('ldap/base')
		schoolName, oudn = schoolenv.create_ou()
		tea1, teadn1 = schoolenv.create_user(schoolName, classes='1A', is_teacher=True)
		stu1, stu1dn = schoolenv.create_user(schoolName, classes='1A')
		stu2, stu2dn = schoolenv.create_user(schoolName, classes='2B')

		co = UMCConnection(host)
		co.auth(tea1 ,'univention')

		# add new printer
		doPrinter('A', newPrinterName, schoolName, host)

		# check if the printer exists
		if printerExist(co, newPrinterName, schoolName, basedn) == []:
			utils.fail('Printer not found')

		# order print jobs
		orderPrint(default_printer, stu1, test_file)
		time.sleep(5)
		orderPrint(default_printer, stu2, test_file)
		time.sleep(5)

		# query all orderd print jobs
		alljobs = queryPrintJobs(co, newPrinterName, 'None', schoolName, "", basedn)
		# query all orderd print jobs from classes 1A
		alljobs1A = queryPrintJobs(co, newPrinterName, '1A', schoolName, "", basedn)
		if alljobs1A == alljobs:
			utils.fail('Unexpected job query result')

		# get print jobs
		printJobs1 = getPrintJobs(alljobs, stu1)
		printJobs2 = getPrintJobs(alljobs, stu2)

		# check file type for the printjobs files
		checkPrintJobs(printJobs1)
		checkPrintJobs(printJobs2)

		# download print jobs for stu1 and check the filetype
		downloadPrintJobs(co, stu1, printJobs1[0])

		# FIX-ME accepting a print job from stu1
		try:
			acceptprint(co, stu1, printJobs1[0], newPrinterName)
		except Exception as e:
			print 'Unexpected exception:', e

		# delete a print job for stu 1
		delPrintJob(co, stu1, printJobs1[0])

		# delete a print job for stu 2
		delPrintJob(co, stu2, printJobs2[0])

		# delete the created printer
		doPrinter('D', newPrinterName, schoolName, host)

if __name__ == '__main__':
	sys.exit(main())
