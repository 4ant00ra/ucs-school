#!/usr/share/ucs-test/runner python
## bugs: [40470]
## desc: Check that school-servers (except master and backup) were not added to the DNS forward and reverse lookup zones.
## exposure: safe
## join: true
## roles:
##  - domaincontroller_slave
## tags: [apptest, ucsschool]

from ldap.filter import filter_format
from univention.testing.ucr import UCSTestConfigRegistry
import univention.testing.utils as utils

def main():
	with UCSTestConfigRegistry() as ucr:
		lo = utils.get_ldap_connection()
		ldap_base = ucr.get('ldap/base')
		zone_name = ".".join([rdn[3:] for rdn in  ldap_base.split(',')])

		school_server = ucr.get('hostname') + "." + zone_name

		zone = lo.get(filter_format('zoneName=%s,cn=dns,%s', (zone_name, ldap_base)))
		dns_servers = zone.get('nSRecord', [])
		dns_servers = [dns_server.strip('.') for dns_server in dns_servers]
		
		print "DNS Servers  : %r" % (dns_servers,)
		print "School Server: %r" % (school_server,)
		assert school_server not in dns_servers, "The school server %r is listed as DNS server, which it must not be." % (school_server,)

if __name__ == '__main__':
	main()
